<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
  <div id="app">
    <h1>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h1>
    <form id="uploadForm">
      <div id="dropArea" class="drop-area">
        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞<br>
        <small>(–ú–æ–∂–Ω–æ –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤)</small>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" />
      </div>
      <div class="gallery" id="gallery"></div>

      <div class="params">
        <label for="modelSelect">–¢–∏–ø –æ–±—Ä–∞–±–æ—Ç–∫–∏:</label>
        <select id="modelSelect" name="model_name">
          <option value="all_models">–í—Å–µ –º–æ–¥–µ–ª–∏</option>
          <option value="damage_only">–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è</option>
          <option value="parts_only">–î–µ—Ç–∞–ª–∏</option>
        </select>

        <label for="imgsz">–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (imgsz):</label>
        <input type="number" id="imgsz" name="imgsz" value="640" min="128" max="1280" />

        <label for="conf">Confidence (conf): <span id="confValue">0.25</span></label>
        <input type="range" id="conf" name="conf" min="0.01" max="1" step="0.01" value="0.25" />

        <label for="iou">IOU threshold (iou): <span id="iouValue">0.45</span></label>
        <input type="range" id="iou" name="iou" min="0.01" max="1" step="0.01" value="0.45" />
      </div>

      <button type="submit" id="startBtn">–ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
    </form>

    <div id="processingMessage">–ú–æ–¥–µ–ª—å –¥–µ–ª–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è, –æ–∂–∏–¥–∞–π—Ç–µ...</div>
    <div id="notification"></div>
  </div>

  <div id="resultsContainer"></div>
  
  <!-- –ü–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è -->
  <div id="detectionPanel" class="detection-panel">
    <div class="detection-header">
      <h3>–î–µ—Ç–∞–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è</h3>
      <button id="closePanel" class="close-panel-btn">√ó</button>
    </div>
    <div id="detectionList" class="detection-list">
      <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã -->
    </div>
  </div>

  <div id="modal">
    <div class="modal-content">
      <div class="modal-left">
        <img id="modalImage" src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
        <canvas id="modalCanvas" class="modal-canvas"></canvas>
      </div>
      <div class="modal-right">
        <div class="modal-header">
          <h3>–î–µ—Ç–µ–∫—Ü–∏–∏</h3>
          <button class="close-btn" id="closeModal">√ó</button>
        </div>
        <div id="modalDetectionList" class="modal-detection-list">
          <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –¥–µ—Ç–µ–∫—Ü–∏–∏ -->
        </div>
      </div>
    </div>
  </div>

  <script src="/static/js/scripts.js"></script>
  
  <script>
    let lastActivityTime = Date.now();
    let inactivityTimer = null;
    const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    async function clearTmpFiles() {
      try {
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—á–∏—Å—Ç–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...');
        const response = await fetch('/clear_tmp', {
          method: 'POST'
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã:', result.message);
        } else {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:', response.status);
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:', error);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    function updateActivityTime() {
      lastActivityTime = Date.now();
      console.log('üîÑ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', new Date(lastActivityTime).toLocaleTimeString());
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
      if (inactivityTimer) {
        clearTimeout(inactivityTimer);
      }
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä
      inactivityTimer = setTimeout(function() {
        console.log('‚è∞ –ü—Ä–æ—à–ª–æ 10 –º–∏–Ω—É—Ç –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è, –æ—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã...');
        clearTmpFiles();
      }, INACTIVITY_TIMEOUT);
    }

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –æ—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã...');
      clearTmpFiles();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
      updateActivityTime();
    });

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
      console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –æ—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã...');
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º sendBeacon –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
      if (navigator.sendBeacon) {
        navigator.sendBeacon('/clear_tmp');
      } else {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        clearTmpFiles();
      }
    });

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
    activityEvents.forEach(function(event) {
      document.addEventListener(event, updateActivityTime, true);
    });

    // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        console.log('üîÑ –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...');
        updateActivityTime();
      }
    });
  </script>
</body>
</html>